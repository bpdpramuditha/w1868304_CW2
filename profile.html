<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #000;
        color: white;
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
      }

      .app-container {
        width: 100%;
        max-width: 390px;
        display: flex;
        flex-direction: column;
      }

      .top-nav,
      .bottom-nav {
        background-color: #000;
        padding: 10px 20px;
        position: fixed;
        width: 100%;
        max-width: 390px;
        z-index: 1000;
      }

      .top-nav {
        top: 0;
        border-bottom: 1px solid #222;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .bottom-nav {
        bottom: 0;
        border-top: 1px solid #222;
        display: flex;
        justify-content: space-around;
      }

      .main-content {
        padding: 80px 15px 70px 15px;
        flex-grow: 1;
        overflow-y: auto;
      }

      .profile-header {
        text-align: center;
        margin-bottom: 20px;
      }

      .profile-img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 10px;
      }

      .post-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
      }

      .post-grid img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="top-nav">
        <span class="fw-bold fs-5">MyProfile</span>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
          Logout
        </button>
      </div>

      <div class="main-content" id="profileContainer"></div>

      <div class="bottom-nav">
        <a href="dashBoard.html" class="text-white"
          ><i class="bi bi-house fs-4"></i
        ></a>
        <a href="#" class="text-white"><i class="bi bi-search fs-4"></i></a>
        <a href="#" class="text-white"
          ><i class="bi bi-plus-square fs-4"></i
        ></a>
        <a href="#" class="text-white"><i class="bi bi-heart fs-4"></i></a>
        <a href="profile.html" class="text-white"
          ><i class="bi bi-person fs-4"></i
        ></a>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $("#logoutBtn").click(() => {
        $.ajax({
          url: "http://localhost:5000/logout",
          type: "POST",
          xhrFields: { withCredentials: true },
          success: () => {
            window.location.href = "userLogin.html";
          },
          error: () => {
            alert("Logout failed.");
          },
        });
      });

      $(document).ready(() => {
        $.get("http://localhost:5000/sessionUser", (sessionData) => {
          const username = sessionData.username;
          loadUserProfile(username);
        });
      });

      $(document).on("click", "#viewFollowers", function (e) {
        e.preventDefault();
        $.get(`http://localhost:5000/followers/${username}`, (followers) => {
          let listHTML = `<div class="post-card"><h5>Followers</h5>`;
          followers.forEach((user) => {
            listHTML += `
        <div class="d-flex align-items-center mb-2">
          <img src="${user.profile_picture}" class="profile-img me-2" />
          <span>@${user.username}</span>
        </div>`;
          });
          listHTML += `</div>`;
          $("#countryData").html(listHTML);
        });
      });

      $(document).on("click", "#viewFollowing", function (e) {
        e.preventDefault();
        $.get(`http://localhost:5000/following/${username}`, (following) => {
          let listHTML = `<div class="post-card"><h5>Following</h5>`;
          following.forEach((user) => {
            listHTML += `
        <div class="d-flex align-items-center mb-2">
          <img src="${user.profile_picture}" class="profile-img me-2" />
          <span>@${user.username}</span>
        </div>`;
          });
          listHTML += `</div>`;
          $("#countryData").html(listHTML);
        });
      });

      function loadUserProfile(username) {
        $.get(
          `http://localhost:5000/profile/${encodeURIComponent(username)}`,
          (data) => {
            const user = data.user;
            const posts = data.posts;

            const profileHTML = `
          <div class="profile-header text-center mb-4">
            <img src="${
              user.profile_picture || "https://via.placeholder.com/100"
            }" class="profile-img mb-2" />
            <h5>@${user.username}</h5>
            <p>${user.full_name || ""}</p>
            <p>
              <strong><a href="#" id="viewFollowers" class="text-white">${
                data.followers
              }</a></strong> Followers |
              <strong><a href="#" id="viewFollowing" class="text-white">${
                data.following
              }</a></strong> Following
            </p>
            <button id="editProfile" class="btn btn-outline-light btn-sm mt-2">Edit Profile</button>
          </div>

          <div class="post-grid d-flex flex-wrap gap-2 justify-content-center">
            ${posts
              .map(
                (post) => `
              <img src="${post.image_url}" alt="Post" style="width: 100px; height: 100px; object-fit: cover;" class="rounded" />
            `
              )
              .join("")}
          </div>`;

            $("#profileContainer").html(profileHTML);
          }
        ).fail((err) => {
          $("#profileContainer").html(`
          <div class="alert alert-danger">Failed to load profile: ${
            err.responseJSON?.message || "Server error"
          }</div>
        `);
        });
      }
    </script>
  </body>
</html>
