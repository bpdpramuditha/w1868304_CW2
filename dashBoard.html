<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f8f9fa;
      }

      .container {
        text-align: center;
        max-width: 500px;
      }

      #generateApiKey,
      #getCountryData {
        padding: 8px 16px;
        font-size: 14px;
        margin-top: 10px;
      }

      #countryData {
        margin-top: 20px;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button id="generateApiKey" class="btn btn-success">
        Generate API Key
      </button>

      <hr />

      <h4>Get Country Data</h4>
      <input
        type="text"
        id="countryInput"
        class="form-control"
        placeholder="Enter country name (e.g., Sri Lanka)"
      />
      <button id="getCountryData" class="btn btn-success">
        Get Country Info
      </button>

      <div id="countryData" class="mt-4"></div>
    </div>

    <script>
      apiKey = "";
      $("#generateApiKey").click(() => {
        generateApiKey();
      });

      $("#getCountryData").click(() => {
        const country = $("#countryInput").val().trim();
        if (!country) return alert("Please enter a country name.");
        getCountryInfo(country);
      });

      function generateApiKey() {
        $.ajax({
          url: "http://localhost:5000/generateApiKey",
          type: "POST",
          data: {},
          credentials: "include", // Send cookies with the request
          success: (res) => {
            if (!res.success) {
              alert(res.message);
            } else {
              apiKey = res.data;
              alert("API Key Generated: " + res.data);
            }
          },
          error: (xhr) => {
            if (xhr.status === 402) {
              alert("You must be logged in to generate an API key.");
              window.location.href = "/userLogin.html";
            } else {
              alert("Error Generating ApiKey. Check server connection.");
            }
          },
        });
      }

      function getCountryInfo(country) {
        $.ajax({
          url: `http://localhost:5000/country/${encodeURIComponent(country)}`,
          type: "GET",
          headers: {
            "X-API-Key": apiKey,
          },
          credentials: "include", // Send cookies with the request
          success: (data) => {
            const html = `
                         <div class="card shadow-sm p-4 border-0 rounded-4" style="max-width: 500px; margin: auto;">
                             <div class="card-body text-center">
                                 <h3 class="card-title mb-3 fw-bold">${
                                   data.name
                                 }</h3>
                                 ${
                                   data.flag
                                     ? `<img src="${data.flag}" alt="Flag of ${data.name}" class="mb-3" style="width: 120px; border-radius: 8px;">`
                                     : ""
                                 }
                                 <p class="mb-2"><strong>Capital City:</strong> ${
                                   data.capital || "N/A"
                                 }</p>
                                 <p class="mb-2"><strong>Currency:</strong> ${
                                   data.currency || "N/A"
                                 }</p>
                                 <p class="mb-2"><strong>Languages:</strong> ${
                                   data.languages?.toLocaleString() || "N/A"
                                 }</p>
                             </div>
                         </div>
                     `;
            $("#countryData").html(html);
          },
          error: (xhr) => {
            if (xhr.status === 402) {
              alert("Session expired or unauthorized. Please login.");
              window.location.href = "/userLogin.html";
            } else if (xhr.status === 403) {
              alert("API Key was not generated. Generate Key");
            } else {
              let message = "Error fetching data.";
              if (xhr.responseJSON && xhr.responseJSON.error) {
                message = xhr.responseJSON.error;
              }
              $("#countryData").html(
                `<div class="alert alert-danger">${message}</div>`
              );
            }
          },
        });
      }
    </script>
  </body>
</html>
