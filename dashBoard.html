<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        background-color: black;
        display: flex;
        justify-content: center;
        font-family: Arial, sans-serif;
        color: white;
      }

      .app-container {
        width: 100%;
        max-width: 390px;
        height: 100vh;
        background-color: black;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .top-nav,
      .bottom-nav {
        background-color: #000;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: fixed;
        width: 100%;
        max-width: 390px;
        z-index: 1000;
      }

      .top-nav {
        top: 0;
        border-bottom: 1px solid #222;
      }

      .bottom-nav {
        bottom: 0;
        border-top: 1px solid #222;
        justify-content: space-around;
      }

      .main-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 70px 15px 70px 15px;
      }

      .profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
      }

      .post-card {
        background-color: #111;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .form-control,
      .form-select {
        background-color: #222;
        color: white;
        border: none;
      }

      .form-control::placeholder {
        color: #aaa;
      }
    </style>
  </head>

  <body>
    <div class="app-container">
      <div class="top-nav">
        <span class="fw-bold fs-5">TravelTales</span>
        <div>
          <a href="/registerUser.html" class="btn btn-outline-light btn-sm me-2"
            >Sign Up</a
          >
          <a href="/userLogin.html" class="btn btn-success btn-sm">Login</a>
        </div>
      </div>

      <div class="main-content">
        <div id="searchSection" style="display: none">
          <input
            type="text"
            id="countryInput"
            class="form-control my-2"
            placeholder="Enter country name"
          />
        </div>

        <label for="sortPosts" class="form-label">Sort Blog Posts By:</label>
        <select id="sortPosts" class="form-select mb-4">
          <option value="newest">Newest</option>
          <option value="liked">Most Liked</option>
          <option value="commented">Most Commented</option>
        </select>

        <div id="feedContainer"></div>

        <div id="countryData"></div>
      </div>

      <div class="bottom-nav">
        <a href="dashBoard.html" class="text-white"
          ><i class="bi bi-house-fill fs-4"></i
        ></a>
        <a href="#" id="searchIcon" class="text-white">
          <i class="bi bi-search fs-4"></i>
        </a>
        <a href="#" class="text-white"
          ><i class="bi bi-plus-square fs-4"></i
        ></a>
        <a href="#" class="text-white"><i class="bi bi-heart fs-4"></i></a>
        <a href="profile.html" class="text-white"
          ><i class="bi bi-person fs-4"></i
        ></a>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
      let apiKey = "";

      $(document).ready(() => {
        $("#countryInput").keypress(function (e) {
          if (e.which === 13) {
            const country = $(this).val().trim();
            if (!country) return alert("Please enter a country name.");

            if (!apiKey) {
              generateApiKey(() => {
                getCountryInfo(country);
              });
            } else {
              getCountryInfo(country);
            }
          }
        });

        $(document).ready(() => {
          $.get("http://localhost:5000/sessionUser", (sessionData) => {
            const username = sessionData.username;
            $("#sessionUsername").text(`@${username}`);
            loadFeed();
          });
        });

        // Toggle search section
        $("#searchIcon").click((e) => {
          e.preventDefault();
          $("#searchSection").slideToggle();
          $("#countryInput").focus();
        });
      });

      function generateApiKey(callback) {
        $.ajax({
          url: "http://localhost:5000/generateApiKey",
          type: "POST",
          data: {},
          xhrFields: { withCredentials: true },
          success: (res) => {
            if (!res.success) {
              alert(res.message);
            } else {
              apiKey = res.data;
              if (typeof callback === "function") callback();
            }
          },
          error: (xhr) => {
            if (xhr.status === 402) {
              alert("You must be logged in to generate an API key.");
              window.location.href = "/userLogin.html";
            } else {
              alert("Error Generating API Key. Check server connection.");
            }
          },
        });
      }

      // Fetch country info
      function getCountryInfo(country) {
        $.ajax({
          url: `http://localhost:5000/country/${encodeURIComponent(country)}`,
          type: "GET",
          headers: {
            "x-api-key": apiKey,
          },
          xhrFields: { withCredentials: true },
          success: (data) => {
            const html = `
                <div class="post-card">
                  <h5>${data.name}</h5>
                  ${
                    data.flag
                      ? `<img src="${data.flag}" class="img-fluid mb-2 rounded" alt="Flag of ${data.name}" />`
                      : ""
                  }
                  <p><strong>Capital:</strong> ${data.capital || "N/A"}</p>
                  <p><strong>Currency:</strong> ${data.currency || "N/A"}</p>
                  <p><strong>Languages:</strong> ${
                    data.languages?.toLocaleString() || "N/A"
                  }</p>
                </div>`;
            $("#countryData").html(html);
          },
          error: (xhr) => {
            let message = "Error fetching data.";
            if (xhr.responseJSON && xhr.responseJSON.error) {
              message = xhr.responseJSON.error;
            }
            $("#countryData").html(
              `<div class="alert alert-danger">${message}</div>`
            );
          },
        });

        function loadFeed() {
          $.ajax({
            url: "http://localhost:5000/feed",
            type: "GET",
            xhrFields: { withCredentials: true },
            success: (posts) => {
              if (!posts.length) {
                $("#feedContainer").html(
                  `<div class="text-center text-muted mt-4">No posts yet from followed users.</div>`
                );
                return;
              }

              const feedHTML = posts
                .map(
                  (post) => `
                    <div class="post-card">
                      <div class="d-flex align-items-center mb-2">
                        <img src="${
                          post.profile_picture
                        }" class="profile-img me-2" />
                        <strong>@${post.username}</strong>
                      </div>
                      <img src="${
                        post.image_url
                      }" class="img-fluid rounded mb-2" />
                      <p><strong>${post.likes || 0} likes</strong></p>
                      <p>${post.caption || ""}</p>
                    </div>
                  `
                )
                .join("");

              $("#feedContainer").html(feedHTML);
            },
            error: () => {
              $("#feedContainer").html(
                `<div class="alert alert-danger">Failed to load feed.</div>`
              );
            },
          });
        }
      }
    </script>
  </body>
</html>
